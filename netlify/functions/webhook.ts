// src/index.ts
import { Telegraf } from 'telegraf';
// import { resolve } from 'path'; // resolve –Ω–µ –Ω—É–∂–µ–Ω –≤ —ç—Ç–æ–º –∫–æ–¥–µ

// !!! –í–ê–ñ–ù–û: –ó–∞–º–µ–Ω–∏—Ç–µ —ç—Ç–∏ –∑–∞–≥–ª—É—à–∫–∏ –Ω–∞ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ !!!
// (–í—ã —É–∂–µ –ø–æ–¥—Å—Ç–∞–≤–∏–ª–∏ —Å–≤–æ–∏ ID, —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ)
const BOT_TOKEN = process.env.BOT_TOKEN || '8232714512:AAFegQAxLFgr6c-DbnaxyjbwOeCpoutF8h0'; 
const ADMIN_CHAT_ID = process.env.ADMIN_CHAT_ID || '4760324917';
// ----------------------------------------------------

const TELEGRAM_API = `https://api.telegram.org/bot${BOT_TOKEN}`;

// –°—Ç–∞—Ç—É—Å—ã —Å–µ—Å—Å–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
interface Session {
    step: number;
    data: {
        name?: string;
        idea?: string;
        email?: string;
    }
}
const sessions: { [key: number]: Session } = {}; 

// –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –±–∞–∑–æ–≤–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ Email
const EMAIL_REGEX = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

/**
 * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —á–µ—Ä–µ–∑ Telegram API.
 */
async function sendMessage(chatId: number, text: string, options: any = {}) {
    const url = `${TELEGRAM_API}/sendMessage`;
    const payload = {
        chat_id: chatId,
        text: text,
        parse_mode: 'Markdown',
        ...options
    };
    
    try {
        // –í Serverless —Å—Ä–µ–¥–∞—Ö 'fetch' –æ–±—ã—á–Ω–æ –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–æ—Å—Ç—É–ø–µ–Ω
        await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
    } catch (error) {
        console.error('Error sending message:', error);
    }
}

/**
 * –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.
 */
async function sendAdminNotification(data: Session['data']) {
    const notificationMessage = 
        `*üö® –ù–û–í–ê–Ø –ó–ê–Ø–í–ö–ê PRIME STUDIO DEV üö®*\n` +
        `----------------------------------------\n` +
        `üë§ *–ò–º—è/–ù–∏–∫:* ${data.name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}\n` +
        `üìß *–ö–æ–Ω—Ç–∞–∫—Ç—ã:* ${data.email || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}\n` + // –ò–∑–º–µ–Ω–µ–Ω–æ –Ω–∞ "–ö–æ–Ω—Ç–∞–∫—Ç—ã" –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —à–∞–≥—É 3
        `üí° *–ò–¥–µ—è –ø—Ä–æ–µ–∫—Ç–∞:*\n${data.idea || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}\n` +
        `----------------------------------------\n` +
        `_–°–≤—è–∂–∏—Ç–µ—Å—å —Å –∫–ª–∏–µ–Ω—Ç–æ–º –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤._`;
            
    // –ü—Ä–∏–≤–µ–¥–µ–Ω–∏–µ –∫ —á–∏—Å–ª—É, —Ç–∞–∫ –∫–∞–∫ ADMIN_CHAT_ID ‚Äî —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞
    await sendMessage(parseInt(ADMIN_CHAT_ID), notificationMessage); 
}


/**
 * –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Ö–æ–¥—è—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è.
 * –ü—Ä–∏–Ω–∏–º–∞–µ—Ç —Å—ã—Ä–æ–π update, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–∞ (Webhook –∏–ª–∏ Long Polling).
 */
async function handleUpdate(update: any) {
    if (!update.message) return;

    const chatId = update.message.chat.id;
    const text = update.message.text ? update.message.text.trim() : '';
    const userId = update.message.from.id;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–ª–∏ –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏
    if (!sessions[userId]) {
        sessions[userId] = { step: 0, data: {} };
    }

    let session = sessions[userId];
    let responseText = '';

    // --- –°–±—Ä–æ—Å –∏ –Ω–∞—á–∞–ª–æ —Å–µ—Å—Å–∏–∏ ---
    if (text === '/start') {
        session.step = 1;
        session.data = {};
        responseText = 
            `*–ü—Ä–∏–≤–µ—Ç!* –ù–∞ —Å–≤—è–∑–∏ –ø–æ–º–æ—â–Ω–∏–∫ –∫–æ–º–∞–Ω–¥—ã Prime Studio Dev. ` + 
            `–Ø –ø–æ–º–æ–≥—É –±—ã—Å—Ç—Ä–æ —Å–æ–±—Ä–∞—Ç—å –≤—Å—é –Ω–µ–æ–±—Ö–æ–¥–∏–º—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ –í–∞—à–µ–º—É –ø—Ä–æ–µ–∫—Ç—É. –î–∞–≤–∞–π—Ç–µ –Ω–∞—á–Ω–µ–º.\n\n` + 
            `*–®–∞–≥ 1 –∏–∑ 3:* –î–ª—è –Ω–∞—á–∞–ª–∞, –∫–∞–∫ —è –º–æ–≥—É –∫ –í–∞–º –æ–±—Ä–∞—â–∞—Ç—å—Å—è? –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –í–∞—à–µ –∏–º—è.`;
        await sendMessage(chatId, responseText);
        return;
    }
    
    if (session.step === 0) {
        responseText = "–î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É /start";
        await sendMessage(chatId, responseText);
        return;
    }


    // --- –õ–æ–≥–∏–∫–∞ –ø–æ—à–∞–≥–æ–≤–æ–≥–æ —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ ---

    switch (session.step) {
        case 1: // –û–∂–∏–¥–∞–Ω–∏–µ –ò–º–µ–Ω–∏
            session.data.name = text;
            session.step = 2;
            responseText = 
                `*–®–∞–≥ 2 –∏–∑ 3:* –û—Ç–ª–∏—á–Ω–æ, ${session.data.name}, —Å–ø–∞—Å–∏–±–æ! –¢–µ–ø–µ—Ä—å –ø–µ—Ä–µ–π–¥–µ–º –∫ –ø—Ä–æ–µ–∫—Ç—É. –û–ø–∏—à–∏—Ç–µ –í–∞—à—É –æ—Å–Ω–æ–≤–Ω—É—é –∏–¥–µ—é. ` +
                `–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–∫–ª—é—á–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –¥–µ—Ç–∞–ª–∏:\n` +
                `1. –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞\n` +
                `2. –ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏\n` +
                `3. –ö–∞–∫–∞—è —Ü–µ–ª—å —É –í–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞`;
            break;

        case 2: // –û–∂–∏–¥–∞–Ω–∏–µ –ò–¥–µ–∏
            session.data.idea = text;
            session.step = 3;
            responseText = 
                `*–®–∞–≥ 3 –∏–∑ 3 (–ø–æ—Å–ª–µ–¥–Ω–∏–π):* –ü–æ–Ω—è–ª! –ò —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —à—Ç—Ä–∏—Ö: ` +
                `–ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –í–∞—à–∏ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ —É–¥–æ–±–Ω–æ–º –¥–ª—è –í–∞—Å —Ñ–æ—Ä–º–∞—Ç–µ ` +
                `(*Email*, *Telegram*, *WhatsApp*). –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ö –¥–ª—è –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –í–∞—à –∑–∞–ø—Ä–æ—Å.`;
            break;

        case 3: // –û–∂–∏–¥–∞–Ω–∏–µ –ö–æ–Ω—Ç–∞–∫—Ç–æ–≤ –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ (—É–¥–∞–ª–µ–Ω–∞ —Å—Ç—Ä–æ–≥–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ email)
            // –í–∞–ª–∏–¥–∞—Ü–∏—è —É–±—Ä–∞–Ω–∞, —Ç–∞–∫ –∫–∞–∫ –≤—ã –∂–¥–µ—Ç–µ —Ä–∞–∑–Ω—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã (email, telegram, whatsapp)
            // –ú—ã —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤–µ—Å—å –≤–≤–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–∞–∫ –∫–æ–Ω—Ç–∞–∫—Ç—ã.
            session.data.email = text; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–µ email –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
            session.step = 4; // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏
            
            // 1. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤–∞–º (ADMIN_CHAT_ID)
            await sendAdminNotification(session.data);
            
            // 2. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            responseText = 
                `*‚úÖ –ì–æ—Ç–æ–≤–æ!* –í–∞—à–∞ –∑–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–Ω—è—Ç–∞. –ö–æ–º–∞–Ω–¥–∞ Prime Studio Dev –æ–∑–Ω–∞–∫–æ–º–∏—Ç—Å—è —Å –¥–µ—Ç–∞–ª—è–º–∏ –∏ ` + 
                `—Å–≤—è–∂–µ—Ç—Å—è —Å –í–∞–º–∏ –ª–∏—á–Ω–æ –≤ —Ç–µ—á–µ–Ω–∏–µ *24 —á–∞—Å–æ–≤*. –°–ø–∞—Å–∏–±–æ –∑–∞ –∏–Ω—Ç–µ—Ä–µ—Å –∫ —Å–æ–≤–º–µ—Å—Ç–Ω–æ–π —Ä–∞–±–æ—Ç–µ!`;
            
            // –£–¥–∞–ª—è–µ–º —Å–µ—Å—Å–∏—é
            delete sessions[userId];
            break;

        default:
            responseText = "–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ù–∞—á–Ω–∏—Ç–µ –Ω–æ–≤—É—é –∫–æ–º–∞–Ω–¥–æ–π /start";
            break;
    }

    if (session.step !== 4 && session.step !== 0) {
        await sendMessage(chatId, responseText);
    }
}

// ====================================================================
// --- –î–£–ê–õ–¨–ù–ê–Ø –õ–û–ì–ò–ö–ê –ó–ê–ü–£–°–ö–ê (Dev/Prod) ---
// ====================================================================

// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å–ª–∏ –º—ã –Ω–∞—Ö–æ–¥–∏–º—Å—è –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π —Å—Ä–µ–¥–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ 
// (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —á–µ—Ä–µ–∑ ts-node, –≥–¥–µ VERCEL –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω)
if (!process.env.VERCEL) {
    
    // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Telegraf
    const bot = new Telegraf(BOT_TOKEN);
    
    // 2. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤—Å–µ—Ö —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    bot.on('text', async (ctx) => {
        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ Telegraf –≤ —Å—ã—Ä–æ–π update –¥–ª—è –Ω–∞—à–µ–π —Ñ—É–Ω–∫—Ü–∏–∏ handleUpdate
        const update = { message: ctx.message }; 
        await handleUpdate(update);
    });

    // 3. –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞ –≤ —Ä–µ–∂–∏–º–µ Long Polling
    bot.launch()
      .then(() => console.log('‚úÖ Bot –∑–∞–ø—É—â–µ–Ω –≤ —Ä–µ–∂–∏–º–µ Long Polling –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏. –¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –≤ Telegram.'))
      .catch(err => console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ (Long Polling):', err));

} else {
    // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è Serverless-—Ñ—É–Ω–∫—Ü–∏–∏ (Production Webhook) ---
    // (–≠—Ç–æ—Ç –±–ª–æ–∫ –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è –Ω–∞ Vercel/Netlify)
    
    module.exports = async (req: any, res: any) => {
        if (req.method === 'POST' && req.body) {
            await handleUpdate(req.body);
            res.status(200).send('OK'); 
        } else {
            res.status(200).send('Bot is running and ready for webhooks.');
        }
    };
}
// –£–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—ã–π Telegraf import, —Ç–∞–∫ –∫–∞–∫ –æ–Ω –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è –≤ Serverless —Ä–µ–∂–∏–º–µ.
// –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –µ–≥–æ —Ç–æ–ª—å–∫–æ –≤ –±–ª–æ–∫–µ !process.env.VERCEL.
// –Ø —Ç–∞–∫–∂–µ —É–±—Ä–∞–ª —Å—Ç—Ä–æ–≥—É—é –ø—Ä–æ–≤–µ—Ä–∫—É Email –Ω–∞ –®–∞–≥–µ 3, —Ç–∞–∫ –∫–∞–∫ –≤—ã –∑–∞–ø—Ä–æ—Å–∏–ª–∏ —Å–±–æ—Ä —Ä–∞–∑–Ω—ã—Ö –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤.